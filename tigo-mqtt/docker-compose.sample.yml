# ============================================================================
# TIGO-MQTT DOCKER COMPOSE - SAMPLE CONFIGURATION
# ============================================================================
# This file is auto-generated by the Realtime Tigo Monitor setup wizard.
# Deploy the dashboard first, then use the wizard to generate a docker-compose.yml
# tailored to your specific hardware setup.
#
# This sample shows a two-CCA (Cloud Connect Advanced) configuration.
# Adjust the number of taptap services to match your setup:
#   - Single CCA:  keep only taptap-primary, remove taptap-secondary
#   - Dual CCA:    use both taptap-primary and taptap-secondary as shown
# ============================================================================

services:

  # --------------------------------------------------------------------------
  # Primary CCA gateway
  # Communicates with a Tigo CCA device over serial (Modbus) and publishes
  # panel metrics (power, voltage, status) to MQTT.
  # --------------------------------------------------------------------------
  taptap-primary:
    build: .
    container_name: taptap-primary
    restart: unless-stopped

    # Host networking required for MQTT broker access on the local network
    network_mode: host
    mem_limit: 256m

    # dialout group grants access to serial devices
    group_add:
      - dialout

    # MQTT credentials loaded from .env file (see .env.example)
    env_file:
      - .env

    # Serial device for this CCA - update to match your hardware
    # Run 'ls /dev/ttyACM*' or 'ls /dev/ttyUSB*' to find your device
    devices:
      - /dev/ttyACM0

    volumes:
      # INI config mapping this CCA's panels (generated by the wizard)
      - ./config-primary.ini:/app/config-template.ini:ro
      # Persistent state directory (tracks panel identification progress)
      - ./data/primary:/data
      # Runtime PID file (used by healthcheck)
      - ./run/primary:/run/taptap

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Healthcheck verifies taptap is running and updated within the last 2 min
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /run/taptap/taptap.run && find /run/taptap/taptap.run -mmin -2 | grep -q ."]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

  # --------------------------------------------------------------------------
  # Secondary CCA gateway (optional - remove for single-CCA setups)
  # Same configuration as primary but pointed at a different serial device.
  # --------------------------------------------------------------------------
  taptap-secondary:
    build: .
    container_name: taptap-secondary
    restart: unless-stopped
    network_mode: host
    mem_limit: 256m
    group_add:
      - dialout
    env_file:
      - .env

    # Second serial device - update to match your hardware
    devices:
      - /dev/ttyACM1

    volumes:
      - ./config-secondary.ini:/app/config-template.ini:ro
      - ./data/secondary:/data
      - ./run/secondary:/run/taptap

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /run/taptap/taptap.run && find /run/taptap/taptap.run -mmin -2 | grep -q ."]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

  # --------------------------------------------------------------------------
  # Temp ID Monitor
  # Watches taptap container logs for temporary ID assignments and publishes
  # alerts to MQTT. Requires Docker socket access to read container logs.
  # --------------------------------------------------------------------------
  temp-id-monitor:
    build: ./temp-id-monitor
    container_name: temp-id-monitor
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    environment:
      # Container names to monitor - must match the service names above
      - PRIMARY_CONTAINER=taptap-primary
      - SECONDARY_CONTAINER=taptap-secondary
      # For single-CCA setups, replace SECONDARY_CONTAINER with:
      # - ENABLE_SECONDARY=false
    volumes:
      # Docker socket required for reading container logs
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - taptap-primary
      - taptap-secondary
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
