services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        # Enable inline cache to fix docker compose build caching issues
        # See: https://github.com/docker/for-mac/issues/7341
        - BUILDKIT_INLINE_CACHE=1
    ports:
      - "3050:8000"
    env_file:
      - ./backend/.env
    environment:
      # State file paths for bootstrapping status check
      - TAPTAP_PRIMARY_STATE_FILE=/app/state/primary/taptap.state
      - TAPTAP_SECONDARY_STATE_FILE=/app/state/secondary/taptap.state
    volumes:
      # Config directory - writable for setup wizard to save YAML configs
      - ../config:/app/config
      - ../assets/layout.png:/app/static/layout.png:ro
      # Mount taptap state files for status checking (read-only)
      - ../tigo-mqtt/data/primary:/app/state/primary:ro
      - ../tigo-mqtt/data/secondary:/app/state/secondary:ro
    networks:
      - solar-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_WS_URL=
        - VITE_API_BASE=
        # Enable inline cache to fix docker compose build caching issues
        # See: https://github.com/docker/for-mac/issues/7341
        - BUILDKIT_INLINE_CACHE=1
    ports:
      - "5174:80"
    depends_on:
      - backend
    networks:
      - solar-network
    restart: unless-stopped

networks:
  solar-network:
    driver: bridge
